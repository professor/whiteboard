  <% content_for :title, "Gradebook" %>

<h1>Gradebook: <%= @course.name %></h1>

<%= link_to "Back", course_path(@course) %> |
<%= link_to "Grading Deliverables", professor_deliverables_path(current_user) %> |
<%= link_to @course.nomenclature_title, course_assignments_path(@course) %> |
<%= link_to "Export as xls", course_export_gradebook_path(@course) %> |

<% form_for(:import_spreadsheet, url: course_import_gradebook_path(@course), html: {multipart: true}) do |f| %>
  <%= f.file_field :import_spreadsheet %>
<% end %>

<table class="cmu_table inner_border">
  <thead>
    <tr>
      <th>Team</th>
      <th>Student</th>
      <% @course.assignments.each do |assignment| %>
        <th><%= assignment.formatted_title %><br/>(<%= @course.grading_criteria == "Percentage" ? "#{assignment.weight}%" : "Max: #{assignment.weight}" %>)</th>
      <% end %>
      <th>Earned<br/>Total <br/><%= @course.grading_criteria == "Percentage" ? "" : "(Max: #{@course.total_assignment_weight})"%></th>
      <th>Earned<br/>Letter Grade</th>
      <th>Final<br/>Letter Grade</th>
    </tr>
  </thead>

  <%
    def deliverable_grade_link_text(deliverable_grade)
      if deliverable_grade.blank?
        "Ungraded"
      else
        if deliverable_grade.deliverable.status == 'Graded'
          deliverable_grade.grade
        elsif deliverable_grade.deliverable.attachment_versions.blank?
          "Unsubmitted"
        elsif deliverable_grade.deliverable.status == 'Ungraded'
          "Ungraded"
        else
          "#{deliverable_grade.grade} (#{deliverable_grade.deliverable.status})"
        end
      end
    end
  %>

  <tbody>
    <% @course.teams.each do |team| %>
      <% team.members.each do |member| %>
        <tr>
          <td><%= team.name %></td>
          <td><%= member.human_name %></td>
          <% number_grade = @course.get_earned_number_grade(member) %>
          <% @course.assignments.each do |assignment| %>
            <td>
              <% deliverable = assignment.deliverable_for_user(member) %>
              <% deliverable_grade = deliverable.blank? ? nil : deliverable.deliverable_grades.find_by_user_id(member.id) %>
              <% if assignment.can_submit? %>
                <% if deliverable.blank? %>
                  <%= link_to "Unsubmitted", assignment_deliverable_create_path(assignment, member) %>
                <% else %>
                  <%= link_to deliverable_grade_link_text(deliverable_grade), deliverable_feedback_path(deliverable) %>
                <% end %>
              <% else %>
                <% if deliverable.blank? || deliverable_grade.blank? || deliverable.status == 'Ungraded' %>
                  <%= link_to "Ungraded", assignment_deliverable_create_path(assignment, member) %>
                <% else %>
                  <%= link_to deliverable_grade.grade, deliverable_feedback_path(deliverable) %>
                <% end %>
              <% end %>
            </td>
          <% end %>
          <td>
            <%= number_grade %><%= @course.grading_criteria == "Percentage" ? "%" : "" %>
          </td>
          <td id="earned_<%= member.id %>"><%= @course.number_to_letter_grade(number_grade) %></td>
          <td>
            <% user_grade = @course.course_user_grades.select {|course_grade| course_grade.user_id == member.id}.first %>
            <%= form_for(:course_user_grade, url: course_user_grades_path, remote: true) do |f| %>
              <% if !user_grade.blank? %>
                <%= f.hidden_field :id, value: user_grade.id %>
              <% end %>
              <%= f.hidden_field :user_id, value: member.id %>
              <%= f.hidden_field :course_id, value: @course.id %>
              <%= f.select :grade, @course.grading_ranges.map {|range| range.grade}, {:selected => user_grade.blank? ? @course.number_to_letter_grade(number_grade) : user_grade.grade}, {:class => 'grade_select'} %>
              <%= f.submit hidden: true %>
            <% end %>
          </td>
        </tr>
      <% end %>
    <% end %>
  </tbody>
</table>

<script>
  function decorateEarnedGrade(userId, finalGrade) {
    var earned_grade = $('#earned_' + userId).html();
    if (earned_grade != finalGrade) {
      $('#earned_' + userId).css({textDecoration: 'line-through'});
    } else {
      $('#earned_' + userId).css({textDecoration: 'none'});
    }
  }

  $(function() {
    $('.grade_select').change(function() {
      $(this).closest('form').submit();
    });

    $('.grade_select').each(function() {
      var finalGrade = $(this).val();
      var userId = $(this).closest('td').prev('td').attr('id').split('_')[1];
      decorateEarnedGrade(userId, finalGrade);
    });

    $('#import_spreadsheet_import_spreadsheet').change(function() {
      if (confirm('Are you sure?')) {
        $(this).closest('form').submit();
      }
    });
  });
</script>